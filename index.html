<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Pro - Play & Withdraw</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        :root { --primary: #ff4b2b; --dark: #090909; --card: #151515; --green: #00e676; --blue: #2979ff; --orange: #f39c12; }
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', sans-serif; }
        body { background: var(--dark); color: #fff; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #withdraw-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center; padding:20px; }
        .modal-content { background:var(--card); padding:25px; border-radius:15px; width:100%; max-width:400px; border:1px solid #333; text-align:center; }
        .referral-box { background:#222; padding:10px; border-radius:5px; margin:15px 0; font-size:0.8rem; border:1px dashed var(--primary); }
        .ref-list { margin-top: 10px; text-align: left; font-size: 0.75rem; max-height: 80px; overflow-y: auto; color: #888; }
        .ref-item { padding: 4px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .explosion { position: absolute; font-size: 80px; z-index: 10; animation: blastPop 0.6s ease-out forwards; display: none; pointer-events: none; }
        @keyframes blastPop { 0% { transform: scale(0.5); opacity: 1; } 100% { transform: scale(2.5); opacity: 0; } }
        #auth-screen { position: fixed; inset: 0; background: var(--dark); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; }
        .top-bar { background: #111; padding: 10px; display: flex; gap: 8px; justify-content: center; border-bottom: 1px solid #222; overflow-x: auto; min-height: 50px;}
        .hist-item { background: #1a1a1a; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; color: #aaa; border: 1px solid #333; font-weight: bold; }
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .side-panel { width: 240px; background: #0e0e0e; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .panel-header { padding: 12px; background: #151515; font-weight: bold; font-size: 0.8rem; color: #888; border-bottom: 1px solid #222; text-transform: uppercase; }
        .bet-list { flex: 1; overflow-y: auto; padding: 8px; font-size: 0.8rem; }
        .bet-row { display: flex; justify-content: space-between; margin-bottom: 6px; background: #1a1a1a; padding: 10px; border-radius: 4px; border-left: 2px solid var(--primary); }
        .game-area { flex: 1; display: flex; flex-direction: column; position: relative; background: #000; }
        #game-screen { flex: 1; position: relative; overflow: hidden; border-bottom: 1px solid #222; }
        #rocket { position: absolute; bottom: 20px; left: 20px; font-size: 50px; transform: rotate(45deg); z-index: 2; transition: 0.1s linear; filter: drop-shadow(0 0 10px var(--primary)); }
        #multiplier { font-size: 6rem; font-weight: 800; margin-top: 120px; text-align: center; color: #fff; }
        #countdown-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; font-weight: 900; color: var(--blue); z-index: 5; }
        .history-panel { height: 180px; background: #050505; border-top: 1px solid #222; overflow-y: auto; padding: 15px; }
        .hist-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .hist-table th { color: #444; text-align: left; padding-bottom: 10px; border-bottom: 1px solid #111; }
        .hist-table td { padding: 8px 0; border-bottom: 1px solid #111; color: #ccc; }
        .control-bar { padding: 20px; background: #111; display: flex; gap: 20px; align-items: center; justify-content: center; flex-wrap: wrap; }
        input { width: 120px; padding: 10px; border-radius: 6px; border: 1px solid #333; background: #000; color: #fff; text-align: center; font-size: 1.1rem; }
        .btn-main { height: 50px; padding: 0 30px; border-radius: 6px; border: none; color: #fff; font-weight: bold; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; }
        .btn-withdraw { background: #333; font-size: 0.8rem; padding: 5px 15px; height: auto; border: 1px solid #444; margin-left: 10px;}
    </style>
</head>
<body>

    <div id="withdraw-modal">
        <div class="modal-content">
            <h3 style="color:var(--primary)">Withdraw Funds</h3>
            <p id="wd-status" style="font-size: 0.9rem; margin: 10px 0; color:#aaa;"></p>
            <div id="referral-info" class="referral-box" style="display:none;">
                <p>‚ö†Ô∏è Invite <span id="needed-refs"></span> more active friend(s).</p>
                <div class="ref-list" id="my-ref-list"></div>
                <p style="margin-top:10px; color:#fff; font-size:0.7rem;">Your Invite ID: <b id="u-invite-id" style="color:var(--orange)"></b></p>
                <button onclick="copyInviteLink()" style="background:var(--blue); color:#fff; border:none; padding:5px 10px; border-radius:4px; font-size:0.7rem; margin-top:5px; cursor:pointer;">Copy Invite Link</button>
            </div>
            <div id="wd-action-area">
                <p style="margin-bottom:10px;">Amount: <b id="wd-amount-val" style="color:var(--green)"></b></p>
                <button class="btn-main" id="btn-submit-wd" style="background:var(--green); width:100%" onclick="submitWithdraw()">REQUEST WITHDRAW</button>
            </div>
            <button onclick="closeWD()" style="background:transparent; color:#666; border:none; margin-top:15px; cursor:pointer;">Close</button>
        </div>
    </div>

    <div id="auth-screen">
        <i class="fas fa-rocket" style="font-size: 4rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h1>ROCKET GAME</h1>
        <input type="number" id="u-phone" placeholder="PHONE NUMBER" style="width: 260px; margin-top: 20px;">
        <button class="btn-main" style="background:var(--primary); margin-top:15px; width: 260px;" onclick="enterApp()">PLAY NOW</button>
    </div>

    <div class="top-bar" id="crash-history-bar"></div>
    <div class="main-layout">
        <div class="side-panel">
            <div class="panel-header">Active Players: <span id="live-bet-count">0</span></div>
            <div class="bet-list" id="live-bet-list"></div>
        </div>
        <div class="game-area">
            <div id="game-screen">
                <div id="blast-effect" class="explosion">üí•</div>
                <div id="countdown-box"></div>
                <div id="multiplier">1.00x</div>
                <div id="rocket">üöÄ</div>
            </div>
            <div class="control-bar">
                <div class="input-group">
                    <small style="color:#666">BALANCE</small>
                    <button class="btn-withdraw" onclick="openWD()">WITHDRAW</button><br>
                    <span style="color: var(--green); font-weight: bold; font-size: 1.2rem;">‚Çπ<span id="u-bal">0.00</span></span>
                </div>
                <div id="input-area">
                    <input type="number" id="bet-amt" value="10">
                </div>
                <button id="btn-bet" class="btn-main" style="background:var(--blue)" onclick="placeBet()">BET</button>
                <button id="btn-cancel" class="btn-main" style="background:var(--orange); display:none;" onclick="cancelBet()">CANCEL</button>
                <button id="btn-cash" class="btn-main" style="background:var(--green); display:none;" onclick="cashOut()">CASH OUT</button>
                <div id="wait-msg" style="display:none; color:#555; font-weight:bold;">GAME RUNNING...</div>
            </div>
        </div>
    </div>

    <div class="history-panel">
        <table class="hist-table">
            <thead><tr><th>TIME</th><th>BET</th><th>RESULT</th><th>PAYOUT</th></tr></thead>
            <tbody id="my-history"></tbody>
        </table>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBOgtsEs4yh4R-ohzY3reACaXugG0bkkvM",
            authDomain: "dailytasktracker-1851b.firebaseapp.com",
            databaseURL: "https://dailytasktracker-1851b-default-rtdb.firebaseio.com",
            projectId: "dailytasktracker-1851b",
            storageBucket: "dailytasktracker-1851b.firebasestorage.app",
            messagingSenderId: "663287980512",
            appId: "1:663287980512:web:7c06b6050580a3802fcb85"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let userPh = "", currentMult = 1.00, isRunning = false, hasBet = false, hasCashedOut = false;
        let isBettingAllowed = false, betValue = 0, gameLoop, crashHistoryArr = [];

        function enterApp() {
            userPh = document.getElementById('u-phone').value;
            if(userPh.length < 5) return alert("Enter Phone Number");
            const urlParams = new URLSearchParams(window.location.search);
            const refBy = urlParams.get('ref');
            db.ref('users/' + userPh).once('value', snap => {
                if(!snap.exists()) {
                    db.ref('users/' + userPh).set({ 
                        balance: 200, withdrawCount: 0, activeReferrals: 0, referrals: 0, referredBy: refBy || "direct", isRecharged: false 
                    }).then(() => {
                        if(refBy && refBy !== userPh) db.ref('users/' + refBy + '/referrals').transaction(c => (c || 0) + 1);
                    });
                }
                document.getElementById('auth-screen').style.display = 'none';
                syncData();
                startCountdown();
            });
        }

        async function openWD() {
            db.ref('withdraw_requests').orderByChild('userId').equalTo(userPh).once('value', async snap => {
                let hasPending = false;
                snap.forEach(c => { if(c.val().status === 'pending') hasPending = true; });

                if(hasPending) {
                    alert("You already have a pending withdrawal request! Please wait for approval.");
                    return;
                }

                const userSnap = await db.ref('users/' + userPh).once('value');
                const data = userSnap.val();
                const count = data.withdrawCount || 0;
                const activeRefs = data.activeReferrals || 0;
                const balance = data.balance || 0;
                let limit = [100, 300, 500, 1000][count] || 1000;
                
                document.getElementById('withdraw-modal').style.display = 'flex';
                document.getElementById('u-invite-id').innerText = userPh;
                document.getElementById('wd-amount-val').innerText = "‚Çπ" + limit;
                
                let locked = false;
                if(count == 3 && activeRefs < 1) { locked = true; document.getElementById('needed-refs').innerText = "1"; }
                if(count >= 4 && activeRefs < 2) { locked = true; document.getElementById('needed-refs').innerText = (2 - activeRefs); }
                
                if(locked) {
                    document.getElementById('wd-status').innerText = "Withdrawal Level " + (count+1) + " Locked!";
                    document.getElementById('referral-info').style.display = 'block';
                    document.getElementById('wd-action-area').style.display = 'none';
                    loadMyReferrals();
                } else if(balance < limit) {
                    document.getElementById('wd-status').innerText = "Low Balance! Minimum ‚Çπ" + limit + " needed.";
                    document.getElementById('referral-info').style.display = 'none';
                    document.getElementById('wd-action-area').style.display = 'none';
                } else {
                    document.getElementById('wd-status').innerText = "Ready to Withdraw!";
                    document.getElementById('referral-info').style.display = 'none';
                    document.getElementById('wd-action-area').style.display = 'block';
                }
            });
        }

        function submitWithdraw() {
            db.ref('users/' + userPh).once('value', snap => {
                const data = snap.val();
                const count = data.withdrawCount || 0;
                const limit = [100, 300, 500, 1000][count] || 1000;
                
                // Cut balance immediately
                const newBal = (data.balance - limit).toFixed(2);
                db.ref('users/' + userPh).update({ balance: Number(newBal) });
                
                // Add to request queue
                db.ref('withdraw_requests').push({
                    userId: userPh,
                    amount: limit,
                    status: 'pending',
                    time: new Date().toLocaleString()
                }).then(() => {
                    alert("Withdrawal request of ‚Çπ" + limit + " sent! Amount deducted from balance.");
                    closeWD();
                });
            });
        }

        function loadMyReferrals() {
            const refListDiv = document.getElementById('my-ref-list');
            refListDiv.innerHTML = "Checking invited friends...";
            db.ref('users').orderByChild('referredBy').equalTo(userPh).once('value', snap => {
                if(!snap.exists()) {
                    refListDiv.innerHTML = "<div style='color:#555'>No friends found yet.</div>";
                    return;
                }
                refListDiv.innerHTML = "<b>Invited Friends:</b>";
                snap.forEach(child => {
                    const u = child.val();
                    refListDiv.innerHTML += `<div class="ref-item"><span>User ${child.key.slice(-4)}</span><span style="color:${u.isRecharged ? 'var(--green)' : '#888'}">${u.isRecharged ? 'Active ‚úì' : 'Joined'}</span></div>`;
                });
            });
        }

        function copyInviteLink() {
            const link = window.location.origin + window.location.pathname + "?ref=" + userPh;
            navigator.clipboard.writeText(link).then(() => alert("Invite Link Copied!"));
        }

        function closeWD() { document.getElementById('withdraw-modal').style.display = 'none'; }

        function syncData() {
            db.ref('users/' + userPh + '/balance').on('value', snap => {
                document.getElementById('u-bal').innerText = Number(snap.val() || 0).toFixed(2);
            });
            db.ref('history/' + userPh).limitToLast(8).on('value', snap => {
                const tbody = document.getElementById('my-history');
                tbody.innerHTML = "";
                snap.forEach(child => {
                    let d = child.val();
                    let color = d.win > 0 ? 'var(--green)' : '#ff4b2b';
                    tbody.innerHTML = `<tr><td>${d.time}</td><td>‚Çπ${d.bet}</td><td>${d.mult}x</td><td style="color:${color}">${d.win > 0 ? '+' : ''}‚Çπ${d.win}</td></tr>` + tbody.innerHTML;
                });
            });
        }

        function startCountdown() {
            let count = 6;
            hasBet = false; hasCashedOut = false; currentMult = 1.00;
            isBettingAllowed = true;
            document.getElementById('live-bet-count').innerText = "0";
            document.getElementById('live-bet-list').innerHTML = "";
            document.getElementById('multiplier').innerText = "1.00x";
            document.getElementById('multiplier').style.color = "white";
            document.getElementById('rocket').style.display = "block";
            document.getElementById('rocket').style.bottom = "20px";
            document.getElementById('rocket').style.left = "20px";
            document.getElementById('blast-effect').style.display = "none";
            document.getElementById('btn-bet').style.display = 'block';
            document.getElementById('btn-cancel').style.display = 'none';
            document.getElementById('btn-cash').style.display = 'none';
            document.getElementById('wait-msg').style.display = 'none';
            
            let timer = setInterval(() => {
                document.getElementById('countdown-box').innerText = count > 0 ? count : "GO!";
                if(count < 0) {
                    clearInterval(timer);
                    document.getElementById('countdown-box').innerText = "";
                    isBettingAllowed = false;
                    document.getElementById('btn-cancel').style.display = 'none';
                    if(!hasBet) {
                        document.getElementById('btn-bet').style.display = 'none';
                        document.getElementById('wait-msg').style.display = 'block';
                    } else {
                        document.getElementById('btn-cash').style.display = 'block';
                    }
                    launchRocket();
                }
                count--;
            }, 1000);
        }

        function placeBet() {
            if(!isBettingAllowed) return;
            betValue = Number(document.getElementById('bet-amt').value);
            let bal = Number(document.getElementById('u-bal').innerText);
            if(betValue < 1 || betValue > bal) return;
            db.ref('users/' + userPh).update({ balance: Number((bal - betValue).toFixed(2)) });
            hasBet = true;
            document.getElementById('live-bet-count').innerText = "1";
            document.getElementById('live-bet-list').innerHTML = `<div class="bet-row"><span>${userPh.slice(-4)}</span><span>‚Çπ${betValue}</span></div>`;
            document.getElementById('btn-bet').style.display = 'none';
            document.getElementById('btn-cancel').style.display = 'block';
        }

        function cancelBet() {
            if(!isBettingAllowed || !hasBet) return;
            let bal = Number(document.getElementById('u-bal').innerText);
            db.ref('users/' + userPh).update({ balance: Number((bal + betValue).toFixed(2)) });
            hasBet = false;
            document.getElementById('live-bet-count').innerText = "0";
            document.getElementById('live-bet-list').innerHTML = "";
            document.getElementById('btn-cancel').style.display = 'none';
            document.getElementById('btn-bet').style.display = 'block';
        }

        function launchRocket() {
            isRunning = true;
            let cp;
            let seed = Math.random() * 100;
            if (seed < 25) cp = 1.00 + (Math.random() * 0.05);
            else if (seed < 55) cp = 1.2 + (Math.random() * 0.8);
            else if (seed < 90) cp = 2.0 + (Math.random() * 3.0);
            else cp = 5.0 + (Math.random() * 10.0);
            cp = Number(cp.toFixed(2));
            gameLoop = setInterval(() => {
                currentMult += (currentMult < 3 ? 0.03 : 0.08);
                document.getElementById('multiplier').innerText = currentMult.toFixed(2) + "x";
                let move = (currentMult - 1) * 40;
                const rkt = document.getElementById('rocket');
                rkt.style.bottom = (20 + move) + "px";
                rkt.style.left = (20 + move) + "px";
                if(currentMult >= cp) {
                    clearInterval(gameLoop);
                    isRunning = false;
                    document.getElementById('blast-effect').style.left = rkt.style.left;
                    document.getElementById('blast-effect').style.bottom = rkt.style.bottom;
                    document.getElementById('blast-effect').style.display = "block";
                    rkt.style.display = "none";
                    document.getElementById('multiplier').style.color = "#ff4b2b";
                    document.getElementById('multiplier').innerText = cp.toFixed(2) + "x"; 
                    if(hasBet && !hasCashedOut) saveHistory(betValue, cp.toFixed(2), -betValue);
                    updateTopBar(cp.toFixed(2));
                    setTimeout(startCountdown, 3000);
                }
            }, 80);
        }

        function cashOut() {
            if(!isRunning || hasCashedOut || !hasBet) return;
            hasCashedOut = true;
            let winAmt = Number((betValue * currentMult).toFixed(2));
            db.ref('users/' + userPh + '/balance').once('value', snap => {
                let newB = Number((Number(snap.val()) + winAmt).toFixed(2));
                db.ref('users/' + userPh).update({ balance: newB });
                saveHistory(betValue, currentMult.toFixed(2), winAmt);
            });
            document.getElementById('btn-cash').style.display = 'none';
        }

        function updateTopBar(val) {
            crashHistoryArr.unshift(val);
            if(crashHistoryArr.length > 8) crashHistoryArr.pop();
            document.getElementById('crash-history-bar').innerHTML = crashHistoryArr.map(v => `<div class="hist-item ${v > 10 ? 'high' : v > 3 ? 'mid' : ''}">${v}x</div>`).join("");
        }

        function saveHistory(b, m, w) {
            let time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'});
            db.ref('history/' + userPh).push({ time, bet: b, mult: m, win: w });
        }
    </script>
</body>
</html>